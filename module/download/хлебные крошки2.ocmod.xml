<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Улучшенные хлебные крошки</name>
  <code>imporove breadcrumb</code>
  <version>1.0</version>
  <author>made.html-5.me</author>
  <link>made.html-5.me</link>
	<file path="catalog/view/theme/*/template/product/*.tpl|catalog/view/theme/*/template/checkout/*.tpl|catalog/view/theme/*/template/account/*.tpl|catalog/view/theme/*/template/affiliate/*.tpl|catalog/view/theme/*/template/information/*.tpl">
		<operation>
			<search><![CDATA[
			<ul class="breadcrumb">
			]]></search>
			<add position="replace" offset="4"><![CDATA[
			<ul class="breadcrumb" xmlns:v="http://rdf.data-vocabulary.org/#">
			<?php $last_crumb = array_pop($breadcrumbs); foreach ($breadcrumbs as $breadcrumb) { ?>
			<li typeof="v:Breadcrumb"><a href="<?php echo $breadcrumb['href']; ?>" rel="v:url" property="v:title"><?php echo $breadcrumb['text']; ?></a></li>
			<?php } ?>
			<li style="color: #999;"><?php echo $last_crumb['text']; ?></li>
			</ul>
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[
			public function index() {
			]]></search>
			<add position="before"><![CDATA[
			protected function getPath($parent_id, $current_path = '') {
				$category_info = $this->model_catalog_category->getCategory($parent_id);          
				if ($category_info) {
					if (!$current_path) {
						$new_path = $category_info['category_id'];
					} else {
						$new_path = $category_info['category_id'] . '_' . $current_path;
					}			  
					$path = $this->getPath($category_info['parent_id'], $new_path);			  
					if ($path) {
						return $path;
					} else {
						return $new_path;
					}
				}
			}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[
			if ($product_info) {
			]]></search>
			<add position="after"><![CDATA[
			if(!isset($category_info)) {
				$categories = $this->model_catalog_product->getCategories($this->request->get['product_id']);
				if($categories) {				
					foreach($categories as $category){			  
						$path = $this->getPath($category['category_id']);
						$category_info = $this->model_catalog_category->getCategory($category['category_id']);
						if($path){
							$cat_path = $path;
						}else{
							$cat_path = $category_info['category_id'];
						}				  
						if($category_info) {
							$path = '';
							$cat_path = explode('_', $cat_path);
							foreach ( $cat_path as $path_id) {
							  if (!$path) {
								$path = $path_id;
							  } else {
								$path .= '_' . $path_id;
							  }
								  
							  $category_info = $this->model_catalog_category->getCategory($path_id);
							  
							  if ($category_info) {
								  $data['breadcrumbs'][] = array(
								  'text'      => $category_info['name'],
								  'href'      => $this->url->link('product/category', '&path=' . $path),
								  'separator' => $this->language->get('text_separator')
								  );
								}
							}
						break;
						}			  
					}
				}
			}
			]]></add>
		</operation>
	</file> 
</modification>